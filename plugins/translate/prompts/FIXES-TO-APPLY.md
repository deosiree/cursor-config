# 占位符问题修复 - 待应用的规则修改

## 需要修改的文件
1. `prompt-single.md`
2. `prompt-batch.md`

---

## 修改1: 增强规则2.1（占位符token强约束）

### 位置
两个文件的第8-10行

### 原文
```markdown
2.1 **占位符token强约束（最高优先级）**：输入词条中可能包含形如 `⟦__PH_CURLY_0__⟧` 的占位符token（含左右边界符号 `⟦` 和 `⟧`）。这些token必须：
   - **逐字原样保留**（包括 `⟦`、`⟧`、下划线与数字），禁止改写、加空格、拆分、合并
   - **按输入中出现的顺序原序输出**（禁止换序/挪位）
```

### 修改为
```markdown
2.1 **占位符token强约束（最高优先级）**：输入词条中可能包含形如 `⟦__PH_CURLY_0__⟧` 的占位符token（含左右边界符号 `⟦` 和 `⟧`）。这些token必须：
   - **逐字原样保留**（包括 `⟦`、`⟧`、下划线与数字），禁止改写、加空格、拆分、合并
   - **按输入中出现的顺序原序输出**（禁止换序/挪位）
     - **"原序"定义**: 指占位符token在整个句子中的出现顺序，如原文中依次出现 `⟦__PH_CURLY_0__⟧`、`⟦__PH_CURLY_1__⟧`、`⟦__PH_CURLY_2__⟧`，则翻译后也必须按 0→1→2 的顺序出现
     - **禁止为语序调整**: 即使英文自然语序需要调整句子结构，占位符token的相对顺序也不可改变
   - **句首占位符特别注意**: 若占位符token位于句首，翻译时**必须保持其在句首位置**，不可因首字母大写规则而删除或跳过
```

---

## 修改2: 重写规则8（占位符与格式保护）

### 位置
两个文件的第19-22行

### 原文
```markdown
8. **占位符与格式保护（高优先级）**：你可以为了英文更自然而增删/调整标点，但必须满足：
   - **不可区分占位符（以花括号为准）**：任何花括号占位符（如 `{}`、`{:.3f}`）都不可换序、不可改写；外层 `[]`、`【】`、空格、连字符等只是样式，不影响"花括号占位符序列必须保序"
   - **可区分占位符**：`%1/%2/%x` 允许根据英文语序调整顺序，但格式必须保持（禁止 `% 1`）
   - **括号/后缀**：文件后缀必须保持无空格：`(*.scd)`、`(*.cid)`，禁止输出 `*. scd`、`*. cid`
```

### 修改为
```markdown
8. **占位符顺序与格式保护（最高优先级）**：
   - **占位符token顺序强约束**: 所有占位符token（`⟦__PH_CURLY_X__⟧`）在翻译后必须保持与原文**完全相同的出现顺序**，即使英文自然语序不同，也**不允许**为了语句通顺而改变占位符token的顺序
   - **示例**:
     - ✅ 正确: `目标[⟦__PH_CURLY_0__⟧]中对象[⟦__PH_CURLY_1__⟧]` → `Target [⟦__PH_CURLY_0__⟧] object [⟦__PH_CURLY_1__⟧]` (保持0→1)
     - ❌ 错误: `目标[⟦__PH_CURLY_0__⟧]中对象[⟦__PH_CURLY_1__⟧]` → `Object [⟦__PH_CURLY_1__⟧] of target [⟦__PH_CURLY_0__⟧]` (变成1→0，禁止)
   - **原始占位符规则**: 对于未被token化的原始占位符（`{}`、`{:.3f}`等），同样必须保持原序；外层 `[]`、`【】` 等包装符号可以调整为英文格式，但占位符本身的顺序不可变
   - **可区分占位符**：`%1/%2/%x` 允许根据英文语序调整顺序，但格式必须保持（禁止 `% 1`）
   - **括号/后缀**：文件后缀必须保持无空格：`(*.scd)`、`(*.cid)`，禁止输出 `*. scd`、`*. cid`
   - **翻译策略**: 当遇到多个占位符token时，优先保持原文结构；如需调整语序，应通过改写句子结构（如使用被动语态、调整从句位置等）来保持占位符顺序
```

---

## 修改3: 增强规则10（首字母大写规则）

### 位置 - prompt-single.md
第24行

### 原文
```markdown
10. **首字母大写规则**：翻译的第一个单词的首字母必须大写
```

### 修改为
```markdown
10. **首字母大写规则**：
   - 若英文翻译以**占位符token**（`⟦__PH_CURLY_X__⟧`）或**原始占位符**（`{}`、`{:.3f}`、`%1`、`[{}]`等）开头，**必须保留该占位符**，后续第一个单词可以小写
   - 若英文翻译直接以单词开头，则第一个单词首字母必须大写
   - **关键**: 占位符token `⟦__PH_CURLY_X__⟧` 必须被视为占位符，不可跳过或删除
```

---

### 位置 - prompt-batch.md
第24行

### 原文
```markdown
10. **首字母大写规则**：若英文翻译直接以单词开头，则第一个单词首字母必须大写；若翻译以占位符（如 `{}`、`{:.3f}`、`%1`、`[{}]` 等）开头，则后面出现的第一个单词可以小写
```

### 修改为
```markdown
10. **首字母大写规则**：
   - 若英文翻译以**占位符token**（`⟦__PH_CURLY_X__⟧`）或**原始占位符**（`{}`、`{:.3f}`、`%1`、`[{}]`等）开头，**必须保留该占位符**，后续第一个单词可以小写
   - 若英文翻译直接以单词开头，则第一个单词首字母必须大写
   - **关键**: 占位符token `⟦__PH_CURLY_X__⟧` 必须被视为占位符，不可跳过或删除
```

---

## 测试用例

修改完成后，使用以下测试用例验证：

### 测试1: 句首占位符
**输入:**
```
⟦__PH_CURLY_0__⟧ 资源预警，资源增长速度：⟦__PH_CURLY_1__⟧⟦__PH_CURLY_2__⟧/s
```

**期望输出（保持0→1→2顺序，0在句首）:**
```
⟦__PH_CURLY_0__⟧ resource warning, resource growth rate: ⟦__PH_CURLY_1__⟧⟦__PH_CURLY_2__⟧/s
```

### 测试2: 复杂顺序
**输入:**
```
计算目标[⟦__PH_CURLY_0__⟧]中计算对象[⟦__PH_CURLY_1__⟧]包含的表达式 "⟦__PH_CURLY_2__⟧" 中因子[⟦__PH_CURLY_3__⟧]不存在
```

**期望输出（保持0→1→2→3顺序）:**
```
Factor [⟦__PH_CURLY_3__⟧] does not exist in expression "⟦__PH_CURLY_2__⟧" contained in calculation object [⟦__PH_CURLY_1__⟧] of calculation target [⟦__PH_CURLY_0__⟧]
```
或其他保持0→1→2→3顺序的翻译方式
