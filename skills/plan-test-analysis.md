# Plan模式测试报错分析Skill

## 技能概述

这是一个结构化的问题诊断框架，用于分析测试报错原因并生成修复方案。采用"先分析后修改"的原则，避免盲目改动代码。

**核心原则**：
- 不改代码，只提供分析计划
- 结构化诊断，从错误堆栈到根因分析
- 定量评估，识别关键错误类型和影响范围
- 优先级排序，提供清晰的修复路径

## 触发方式

当遇到以下情况时，自动触发此skill：

1. **明确触发**：
   - 用户说："plan分析"、"plan模式"、"使用plan模式分析"、"先给plan不改代码"
   - 用户输入包含：`@plan`、`[PLAN]`、`plan分析`

2. **自动识别**：
   - 检测到测试报错信息
   - 检测到错误堆栈信息
   - 用户询问"为什么测试失败"、"如何修复测试错误"

## 诊断流程

### Phase 1: 现场采集（Context Collection）

**目标**：收集完整的错误上下文信息

**检查清单**：
- [ ] **错误信息提取**
  - 完整错误消息（Error Message）
  - 错误类型（TypeError, AssertionError, ReferenceError等）
  - 错误位置（文件路径、行号、列号）

- [ ] **堆栈追踪分析**
  - 从下往上梳理调用链（类似SQL执行计划从底层到顶层）
  - 标识关键执行路径
  - 标注每个层级的函数/方法名

- [ ] **环境信息记录**
  - 测试框架版本（Vitest版本）
  - 相关依赖版本
  - 测试配置（vitest.config.js关键设置）
  - 测试环境（jsdom, node等）

- [ ] **相关文件识别**
  - 被测试文件路径
  - 测试文件路径
  - 依赖的模块/组件
  - Mock配置相关文件

### Phase 2: 执行计划生成（Execution Plan Analysis）

**目标**：分析代码执行路径，识别问题节点

**分析方法**（参考SQL EXPLAIN PLAN思路）：

1. **路径验证**（Path Verification）
   - 预期执行路径 vs 实际执行路径
   - 识别是否走了预期分支
   - 检查条件判断是否正确

2. **成本评估**（Cost Analysis）
   - 识别最耗资源的操作（类似SQL的Cost指标）
   - 评估错误影响范围
   - 统计同类错误数量

3. **数据流分析**（Data Flow Analysis）
   - 数据从输入到输出的转换过程
   - 检查是否有意外的数据过滤/转换
   - 验证数据访问方式（直接访问 vs 可选链）

4. **操作类型识别**（Operation Type）
   - 属性访问错误（null/undefined访问）
   - 类型不匹配（expected vs actual）
   - 配置错误（Mock配置、环境配置）
   - 业务逻辑错误

### Phase 3: 根因定位（Root Cause Analysis）

**目标**：找到问题的根本原因

**分析维度**：

| 维度 | 检查项 | 说明 |
|------|--------|------|
| **代码层面** | 属性定义位置 | data()中是否定义了不应该定义的属性 |
| | 空值处理 | 是否缺少可选链或空值检查 |
| | 类型匹配 | 期望类型 vs 实际类型 |
| **测试层面** | Mock配置 | Mock数据是否完整/正确 |
| | 环境配置 | 测试环境是否正确设置 |
| | 断言逻辑 | 断言是否合理 |
| **依赖层面** | Store状态 | Vuex store状态是否正确初始化 |
| | 组件依赖 | 组件依赖是否正确mock |
| | 全局配置 | 全局配置是否正确 |

**根因分析格式**：
```
【根因分析】
问题类型：[属性访问错误/类型不匹配/配置错误/业务逻辑错误]
发生位置：[文件路径:行号]
执行路径：[从调用链底层到顶层的路径]
根本原因：[为什么会出现这个问题]
```

### Phase 4: 修复方案生成（Fix Plan Generation）

**目标**：提供结构化的修复方案，但不修改代码

**方案格式**：

#### 4.1 问题分类汇总

按错误类型分组，统计影响范围：

```
【问题分类】
1. 属性定义错误（X个失败）
   - 文件列表：[文件1, 文件2, ...]
   - 错误模式：[描述错误模式]
   
2. 空值访问错误（Y个失败）
   - 文件列表：[文件1, 文件2, ...]
   - 错误模式：[描述错误模式]
   
3. Mock配置错误（Z个失败）
   - 文件列表：[文件1, 文件2, ...]
   - 错误模式：[描述错误模式]
```

#### 4.2 修复方案列表

为每个问题类型提供修复方案：

```
【修复方案】

方案A：[方案名称]
- 适用场景：[什么情况下使用]
- 修复步骤：
  1. [步骤1]
  2. [步骤2]
  3. [步骤3]
- 预期效果：[修复后预期结果]
- 影响范围：[影响哪些文件/测试]
- 风险评估：[可能的风险]

方案B：[方案名称]
- ...
```

#### 4.3 优先级排序

```
【修复优先级】

高优先级（必须修复）：
- [问题1]：[原因]
- [问题2]：[原因]

中优先级（建议修复）：
- [问题3]：[原因]

低优先级（可选）：
- [问题4]：[原因]
```

#### 4.4 修复验证计划

```
【验证计划】
1. 修复后运行测试：[测试命令]
2. 检查指标：
   - 测试通过率：[当前] → [目标]
   - 失败测试数量：[当前] → [目标]
3. 回归测试：[需要验证的功能点]
```

## 输出格式模板

当触发此skill时，按以下格式输出分析结果：

```markdown
# 测试报错Plan分析报告

## 一、现场信息

### 错误摘要
- **错误类型**：[TypeError/AssertionError/...]
- **错误数量**：X个测试失败，Y个测试通过
- **通过率**：Z%

### 错误详情
[列出主要错误信息]

### 相关文件
- 测试文件：[路径列表]
- 源代码文件：[路径列表]
- 配置文件：[路径列表]

## 二、执行计划分析

### 执行路径追踪
[从错误堆栈分析执行路径]

### 问题节点识别
| 节点 | 预期行为 | 实际行为 | 差异 |
|------|---------|---------|------|
| [节点1] | [预期] | [实际] | [差异] |
| [节点2] | [预期] | [实际] | [差异] |

### 成本评估
- 最高影响：[问题类型] - 影响X个测试
- 修复复杂度：[简单/中等/复杂]

## 三、根因分析

[按问题类型分组分析]

### 问题类型1：[名称]
- **根因**：[根本原因]
- **发生位置**：[文件:行号]
- **影响范围**：[X个测试失败]

### 问题类型2：[名称]
- ...

## 四、修复方案

### 方案概览
[按优先级列出所有方案]

### 详细方案

#### 方案A：[名称]
**适用场景**：[场景描述]
**修复步骤**：
1. [步骤1]
2. [步骤2]
3. [步骤3]

**预期效果**：
- 修复后预期：[描述]
- 测试通过率提升：[X% → Y%]

**影响范围**：
- 需要修改的文件：[列表]
- 需要修改的测试：[列表]

**风险评估**：
- [风险1]：[说明]
- [风险2]：[说明]

#### 方案B：[名称]
[同上格式]

### 修复优先级
1. **高优先级**：[问题列表]
2. **中优先级**：[问题列表]
3. **低优先级**：[问题列表]

## 五、验证计划

### 修复后验证步骤
1. [步骤1]
2. [步骤2]
3. [步骤3]

### 成功标准
- [ ] 所有高优先级问题已修复
- [ ] 测试通过率达到 [X]%
- [ ] 无新增错误

---

**注意**：以上为分析计划，不包含实际代码修改。请确认方案后再进行代码修改。
```

## 项目特定配置

### Vitest测试框架特定分析

针对本项目使用Vitest的情况，重点关注：

1. **Mock配置检查**
   - `tests/setup.js` 中的全局mock配置
   - 组件级别的mock配置
   - API调用的mock配置

2. **Vue组件测试特定问题**
   - Vuex store状态初始化
   - 组件props传递
   - 事件触发和监听
   - 生命周期钩子执行

3. **Ant Design Vue组件问题**
   - 组件stub配置
   - 组件属性访问
   - 组件事件处理

### 常见错误模式识别

基于项目历史错误（参考`错误分析与解决方案.md`），重点关注：

1. **user属性定义错误**
   - 模式：在`data()`中定义了`user`属性，但测试期望它是`undefined`
   - 解决方案：从`data()`中删除`user`属性，直接使用`$store.state.user`

2. **null访问错误**
   - 模式：直接访问`this.user.property`或`this.$store.state.user.property`，但`user`可能为`null`
   - 解决方案：使用可选链`?.`或添加空值检查

3. **权限相关错误**
   - 模式：`$currentDepartment`或相关权限对象未正确mock
   - 解决方案：完善测试setup中的权限mock配置

## 使用示例

### 示例1：触发分析

**用户输入**：
```
@plan 测试报错：TypeError: Cannot read properties of null (reading 'userName')
```

**Skill输出**：
按照上述模板生成完整的分析报告

### 示例2：自动识别

**用户输入**：
```
为什么这个测试失败了？
AssertionError: expected null to be undefined
```

**Skill输出**：
自动识别为测试报错场景，触发plan分析流程

## 最佳实践

1. **先分析后修改**：始终先完成完整的plan分析，再开始代码修改
2. **分类处理**：按错误类型分组，批量处理同类问题
3. **优先级驱动**：优先修复高优先级问题，快速提升通过率
4. **验证驱动**：每个修复方案都包含验证步骤
5. **文档记录**：将分析结果记录到`错误分析与解决方案.md`中，便于后续参考

## 注意事项

1. **不改代码原则**：此skill只提供分析计划，不执行代码修改
2. **上下文完整**：确保收集完整的错误上下文，避免遗漏关键信息
3. **方案可执行**：修复方案应该具体、可执行，避免过于抽象
4. **风险提示**：对于可能引入新问题的修复方案，需要明确提示风险
