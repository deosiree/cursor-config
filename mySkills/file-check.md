# 文件优化点批量分析 Skill（file-check）

## 技能概述

用于**批量分析指定前端文件**（重点面向 Vue/JS/TS）中的：

- **冗余逻辑**：重复代码、重复状态、重复数据转换、可抽取的公共方法
- **逻辑漏洞/风险点**：props 误用、竞态/轮询、状态机缺口、异常分支不一致、潜在空指针/类型不匹配
- **可优化点**：可读性、可维护性、性能、资源释放、代码组织（methods 分组、抽取辅助方法）

输出是**可执行的优化建议清单**（按优先级 + 可落地修改点），不直接改代码（除非用户明确要求“顺便帮我改”）。

---

## 触发方式

### 方式一：明确触发（推荐）

在 Cursor 聊天框输入：

```text
@优化文件 src/views/entry/index.vue src/views/entry/updateModal.vue
```

支持任意数量文件：

```text
@优化文件 文件A 文件B 文件C ...
```

### 方式二：关键词触发

包含以下关键词之一，并同时给出文件路径列表时触发：

- `优化文件`
- `批量分析文件`
- `检查文件优化点`
- `文件冗余逻辑分析`

示例：

```text
帮我优化文件：src/a.vue src/b.vue
```

---

## 输入要求（重要）

- 必须给出**至少 1 个文件路径**（相对路径），并确保文件存在
- 路径之间用空格分隔；若路径包含空格，建议改名避免（本 skill 不做引号解析的强假设）
- 若只给 1 个文件：进行**单文件业务逻辑/风险/冗余**分析；同时提示“缺少跨文件重复逻辑对比”

---

## 分析执行流程（给 AI 的操作指引）

### Step 1：现场采集（逐文件）

对每个文件提取：

- **组件职责**（一句话）
- **核心数据/状态**（data / props / computed / store 使用）
- **关键流程**（mounted/watch/事件/异步请求/轮询）
- **对外接口**（emit、props、ref 调用、依赖的 utils/api）

### Step 2：冗余逻辑识别（单文件 + 跨文件）

- 识别重复模式（两处或以上）：
  - 重复的数据提取/转换
  - 重复的状态切换/弹窗打开关闭
  - 重复的错误处理/提示
  - 重复的 API 参数组装
- 给出**建议抽取的辅助方法**（命名建议：`extractXxx` / `validateXxx` / `transformXxx` / `prepareXxx`）

### Step 3：漏洞/风险点扫描（必须做）

至少覆盖以下类别：

- **Props 误用**：直接写 `this.xxx = ...` 修改 props / 修改 props 对象内部字段
- **状态机缺口**：状态值范围不全、某状态分支没有收敛、loading 卡死
- **竞态/并发**：watch/请求/轮询相互覆盖，旧请求覆盖新状态
- **资源释放**：window 事件、轮询、timer、订阅在 unmounted/beforeUnmount 未清理
- **类型/空值风险**：初始化类型与使用不一致（如 `{} / [] / null` 混用导致 forEach 崩溃）
- **表格选择/列表更新**：用对象引用做删除导致失败；rowKey 不稳定导致错选
- **异常处理一致性**：catch 分支使用错误字段（`error.data` 不存在等），错误码判断异常

### Step 4：可维护性与组织结构（遵循仓库规则）

若 `methods` > 10 个，按以下顺序分组，并用注释：

```javascript
// ==================== 生命周期和初始化相关 ====================
// ==================== UI交互控制（模态框、表单等） ====================
// ==================== 数据操作（上传、验证、处理） ====================
// ==================== 业务逻辑（API调用、数据处理） ====================
// ==================== 辅助功能（工具方法、用户偏好等） ====================
```

并把重复逻辑抽成辅助方法（满足：命名清晰、参数化、单一职责、返回值统一）。

---

## 输出格式（固定模板）

对用户输出以下结构（不要粘贴大段源码）：

### 1. 文件概览

- **文件A**：职责、核心流程、依赖与耦合点
- **文件B**：职责、核心流程、依赖与耦合点
- **交互关系**：A 如何驱动 B（props/emit/ref/缓存/任务状态）

### 2. 冗余逻辑清单（可提取项）

按“重复点 → 影响 → 建议抽取方法签名（伪代码） → 替换位置”列出。

### 3. 风险点/漏洞清单（按优先级）

- **P0（必须修）**：会导致运行时报错/数据错乱/误操作的点
- **P1（强烈建议）**：会导致偶发 bug / 长期维护成本高
- **P2（可优化）**：风格、可读性、性能微优化

每条包含：

- **现象**（会发生什么）
- **触发条件**（何时出现）
- **根因**（代码层原因）
- **建议修复**（明确到“改哪一类逻辑/新增哪一段保护/抽哪一个方法”）

### 4. 建议的重构切分方案（最小可行）

给出一个“最小改动”顺序：

- 先修 P0 风险
- 再抽公共方法
- 最后整理 methods 分组与命名

---

## 针对 `src/views/entry/index.vue` + `src/views/entry/updateModal.vue` 的内置检查点（示例）

当分析这两个文件时，额外强制检查：

- **禁止修改子组件 props**：轮询回调里对 `updateClassfyID` 等 props 赋值属于高风险
- **任务状态与 loading 收敛**：状态为“执行中”时 UI 是否能自动恢复/重新查询/退出
- **缓存 i18nUrl 一致性**：父组件预检查缓存 vs 子组件打开弹窗时缓存回填，是否出现不一致
- **初始化类型一致**：`updateEntries` 初始化为 `{}` 但后续 `forEach` 当数组使用属于 P0
- **表格选中态一致**：`selectedRows` 的增删不能依赖对象引用，应以 `rowKey` 为准

---

## 注意事项

1. **不输出大段源码**：只给定位线索（文件路径 + 函数/变量名 + 简短描述）
2. **建议必须可落地**：避免泛泛而谈，尽量给出替换策略/方法签名
3. **遵循项目既有规范**：尤其是 methods 分组注释格式与重复逻辑提取原则
