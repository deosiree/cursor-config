---
name: 去重回填v1.5解耦实现
overview: 创建去重回填v1.5版本，使用v2的校验API和布局，但使用v1的更新API。v1.5将"更新字段"约束为语种字段，并实现字段名到语种名的转换以兼容v1 API。
todos:
  - id: copy-base-structure
    content: 复制 modal_v2.vue 的基础结构（template、script基础部分、props、data等），创建 modal_v1_5.vue 文件
    status: completed
  - id: update-component-name
    content: 修改第171行的组件名称为 BackFillModal_v1_5
    status: completed
    dependencies:
      - copy-base-structure
  - id: update-import-statement
    content: 修改第161行的导入语句，将 entryBatchImportExcel_v2 改为 entryBatchImportExcel，保留 entryValidate_v2 的导入
    status: completed
    dependencies:
      - update-component-name
  - id: define-language-fields-constant
    content: 在data或computed中定义语种字段常量数组，包含["中文翻译", "英文翻译", "俄文翻译", "西文翻译", "法文翻译"]
    status: completed
    dependencies:
      - update-import-statement
  - id: modify-mounted-field-filtering
    content: 修改第334-347行的mounted方法，将字段过滤逻辑改为只保留语种字段（使用上一步定义的常量）
    status: completed
    dependencies:
      - define-language-fields-constant
  - id: create-map-field-label-to-language-name
    content: 在methods中添加mapFieldLabelToLanguageName方法，实现字段标签到语种名称的映射（如"英文翻译"->"英文"）
    status: completed
    dependencies:
      - modify-mounted-field-filtering
  - id: create-map-field-label-to-field-value
    content: 在methods中添加mapFieldLabelToFieldValue方法，实现字段标签到字段值的映射（如"英文翻译"->"english"）
    status: completed
    dependencies:
      - create-map-field-label-to-language-name
  - id: modify-validation-mode-field-conversion
    content: 在handleOK方法的校验模式部分（第488-502行），添加字段标签到字段值的转换逻辑（使用mapFieldLabelToFieldValue）
    status: completed
    dependencies:
      - create-map-field-label-to-field-value
  - id: modify-update-mode-prepare-params
    content: 在handleOK方法的更新模式部分（第536-546行），准备将backfillFields转换为语种名称数组（使用mapFieldLabelToLanguageName）
    status: completed
    dependencies:
      - create-map-field-label-to-language-name
  - id: modify-update-mode-api-call
    content: 将entryBatchImportExcel_v2调用改为entryBatchImportExcel，传入语种名称数组和formData
    status: completed
    dependencies:
      - modify-update-mode-prepare-params
  - id: read-filter-excel-component
    content: 阅读filterExcel.vue文件，了解现有按钮布局和状态管理结构
    status: completed
    dependencies:
      - modify-update-mode-api-call
  - id: add-v1_5-state-variables
    content: 在filterExcel.vue的data中添加v1_5相关状态变量（importBackfillVisible_v1_5等）
    status: completed
    dependencies:
      - read-filter-excel-component
  - id: add-v1_5-component-import
    content: 在filterExcel.vue的script部分导入BackFillModal_v1_5组件
    status: completed
    dependencies:
      - add-v1_5-state-variables
  - id: add-v1_5-button-template
    content: 在filterExcel.vue的template中添加去重回填v1.5按钮（参考现有按钮位置）
    status: completed
    dependencies:
      - add-v1_5-component-import
  - id: add-v1_5-modal-component
    content: 在filterExcel.vue的template中添加BackFillModal_v1_5组件，绑定相关props和events
    status: completed
    dependencies:
      - add-v1_5-button-template
  - id: add-v1_5-button-handler
    content: 在filterExcel.vue的methods中添加showImportBackfillModal_v1_5等方法
    status: completed
    dependencies:
      - add-v1_5-modal-component
  - id: write-tests-file-setup
    content: 复制BackFillModal_v2.test.js内容到BackFillModal_v1_5.test.js，修改import路径和组件名
    status: completed
    dependencies:
      - modify-update-mode-api-call
  - id: write-tests-update-mocks
    content: 更新测试文件的mock，将entryBatchImportExcel_v2改为entryBatchImportExcel，保留entryValidate_v2
    status: completed
    dependencies:
      - write-tests-file-setup
  - id: write-tests-rendering-button
    content: 编写按钮模式渲染测试（验证组件可以正常挂载，mode为button）
    status: completed
    dependencies:
      - write-tests-update-mocks
  - id: write-tests-rendering-modal
    content: 编写模态框模式渲染测试（验证组件可以正常挂载，mode为modal）
    status: completed
    dependencies:
      - write-tests-rendering-button
  - id: write-tests-field-filtering-positive
    content: 编写字段过滤正向测试（验证fieldOptions只包含语种字段）
    status: completed
    dependencies:
      - write-tests-update-mocks
  - id: write-tests-field-filtering-negative
    content: 编写字段过滤负向测试（验证fieldOptions不包含非语种字段如"词条"）
    status: completed
    dependencies:
      - write-tests-field-filtering-positive
  - id: write-tests-map-to-language-name
    content: 编写字段映射测试-标签到语种名称（验证mapFieldLabelToLanguageName方法正确映射）
    status: completed
    dependencies:
      - write-tests-update-mocks
  - id: write-tests-map-to-field-value
    content: 编写字段映射测试-标签到字段值（验证mapFieldLabelToFieldValue方法正确映射）
    status: completed
    dependencies:
      - write-tests-map-to-language-name
  - id: write-tests-validation-mode-api-call
    content: 编写校验模式API调用测试（验证enableValidate=true时调用entryValidate_v2）
    status: completed
    dependencies:
      - write-tests-update-mocks
  - id: write-tests-validation-mode-field-conversion
    content: 编写校验模式字段转换测试（验证传给API的backfillFields是字段值数组而非标签数组）
    status: completed
    dependencies:
      - write-tests-validation-mode-api-call
  - id: write-tests-update-mode-api-call
    content: 编写更新模式API调用测试（验证enableValidate=false时调用entryBatchImportExcel）
    status: completed
    dependencies:
      - write-tests-update-mocks
  - id: write-tests-update-mode-language-conversion
    content: 编写更新模式语种名称转换测试（验证传给API的translateTypes是语种名称数组如["英文","俄文"]）
    status: completed
    dependencies:
      - write-tests-update-mode-api-call
  - id: write-tests-form-required-fields
    content: 编写表单必填字段验证测试（验证backfillFields和文件字段的必填校验）
    status: completed
    dependencies:
      - write-tests-update-mocks
  - id: write-tests-form-file-format
    content: 编写文件格式验证测试（验证文件扩展名校验逻辑）
    status: completed
    dependencies:
      - write-tests-form-required-fields
---

# 去重回填v1.5解耦实现计划

## 概述

参考v1到v2的解耦过程，创建v1.5版本，实现：

- **UI布局**：复用v2的布局（包括"更新字段"选择器、校验选项等）
- **校验API**：使用v2的校验API (`entryValidate_v2`)
- **更新API**：使用v1的更新API (`entryImportExcle`)，但只支持语种字段
- **约束**："更新字段"只能是语种相关字段（如"英文翻译"、"俄文翻译"等）

## 实现步骤

### 1. 组件基础已准备 ✅

`modal_v1_5.vue` 文件已从 `modal_v2.vue` 拷贝创建。接下来需要对现有组件进行以下修改：

- ✅ 组件文件已创建
- ⏳ 修改组件名称和导入语句
- ⏳ 修改字段选项：只显示语种相关字段（过滤掉"词条"、"comment"、"tag"等非语种字段）
- ⏳ 实现字段名到语种名的映射逻辑

### 2. 实现字段过滤和映射

在 `modal_v1_5.vue` 中：

- 从 `entryParams.exportFields` 中过滤出语种字段（如"英文翻译"、"俄文翻译"、"西文翻译"、"法文翻译"、"中文翻译"）
- 创建字段标签到语种名称的映射（如"英文翻译" -> "英文"）
- 创建字段标签到字段值的映射（如"英文翻译" -> "english"），用于校验API

### 3. 修改更新逻辑

在 `modal_v1_5.vue` 的 `handleOK` 方法中：

- **校验模式**：使用 `entryValidate_v2`，将字段标签转换为字段值（如"英文翻译" -> "english"）
- **更新模式**：使用 `entryBatchImportExcel`（v1的包装函数），将字段标签转换为语种名称（如"英文翻译" -> "英文"），循环调用 `entryImportExcle` API

### 4. 在父组件中添加按钮

在 [`src/views/fileManage/filterExcel.vue`](src/views/fileManage/filterExcel.vue) 中：

- 添加"去重回填v1.5"按钮（第100-105行附近）
- 添加对应的状态变量和方法（`importBackfillVisible_v1_5`、`showImportBackfillModal_v1_5` 等）
- 引入并使用 `BackFillModal_v1_5` 组件

### 5. 编写测试用例

参考 [`tests/unit/components/BackFillModal_v2.test.js`](tests/unit/components/BackFillModal_v2.test.js)，创建 `BackFillModal_v1_5.test.js`：

#### 测试项清单：

1. **组件渲染测试**

- 按钮模式下应该渲染按钮
- 模态框模式下应该不显示主按钮

2. **字段过滤测试**

- 应该只显示语种字段（中文翻译、英文翻译、俄文翻译、西文翻译、法文翻译）
- 应该过滤掉非语种字段（词条、comment、tag等）

3. **字段映射测试**

- 字段标签到语种名称的映射（如"英文翻译" -> "英文"）
- 字段标签到字段值的映射（如"英文翻译" -> "english"）

4. **校验模式测试**

- 勾选"校验"后应该调用 `entryValidate_v2`
- 校验时应该将字段标签转换为字段值传给API
- 校验结果应该正确显示

5. **更新模式测试**

- 不勾选"校验"时应该调用 `entryBatchImportExcel`（v1 API）
- 更新时应该将字段标签转换为语种名称传给API
- 应该循环调用每个语种的 `entryImportExcle` API

6. **表单验证测试**

- 提交时应该验证必填字段
- 文件格式验证

7. **用户偏好功能测试**（如果适用）

- 打开模态框时应该获取用户偏好
- 提交成功后应该保存用户偏好

## 关键实现细节

### 字段过滤规则

只保留以下字段作为"更新字段"选项：

- "中文翻译" (chinese)
- "英文翻译" (english)
- "俄文翻译" (russian)
- "西文翻译" (spanish)
- "法文翻译" (french)

### 映射关系

- **校验API**：需要字段值（如 "english"、"russian"）
- **更新API (v1)**：需要语种名称（如 "英文"、"俄文"）
- **字段标签**：UI显示（如 "英文翻译"、"俄文翻译"）

### 兼容性处理

- v1的更新API接受 `params: { transType: "英文" }`，需要循环调用每个语种
- v2的校验API接受 `backfillFields: ["english", "russian"]`，需要字段值数组

## 文件清单

1. `src/components/Button/fileManage/backFill/modal_v1_5.vue` (✅ 已创建，待修改)
2. `src/views/fileManage/filterExcel.vue` (待修改)
3. `tests/unit/components/BackFillModal_v1_5.test.js` (✅ 已创建，待修改)

## 详细修改说明

### 文件1: `src/components/Button/fileManage/backFill/modal_v1_5.vue`

#### 修改1: 组件名称（第171行）

- **当前**: `name: "BackFillModal_v2"`
- **修改为**: `name: "BackFillModal_v1_5"`

#### 修改2: 导入语句（第161行）

- **当前**: `import { entryBatchImportExcel_v2, entryValidate_v2 } from "@/utils/excelUtils";`
- **修改为**: `import { entryBatchImportExcel, entryValidate_v2 } from "@/utils/excelUtils";`
- **说明**: 将 `entryBatchImportExcel_v2` 改为 `entryBatchImportExcel`（v1 API），保留 `entryValidate_v2`（v2 API）

#### 修改3: 定义语种字段常量（在data中添加）

- **位置**: 在 `data()` 的 `return` 中添加，建议放在 `fieldOptions: []` 之前
- **代码**:
```javascript
languageFields: ["中文翻译", "英文翻译", "俄文翻译", "西文翻译", "法文翻译"], // v1.5只支持语种字段
```


#### 修改4: 修改mounted方法中的字段过滤逻辑（第334-347行）

- **当前逻辑**: 过滤掉翻译id字段
```javascript
const filterColNames = [
  "英文翻译id",
  "俄文翻译id",
  "西文翻译id",
  "法文翻译id",
  "中文翻译id",
];
this.fieldOptions = sourceOptions.filter(
  (item) => !filterColNames.includes(item.label)
);
```

- **修改为**: 只保留语种字段
```javascript
// v1.5只保留语种字段
this.fieldOptions = sourceOptions.filter(
  (item) => this.languageFields.includes(item.label)
);
```


#### 修改5: 添加字段映射方法（在methods中添加）

**方法1: mapFieldLabelToLanguageName**（字段标签 -> 语种名称）

- **位置**: 在 `methods` 中添加，建议放在 `selectAllBackfillFields` 方法之前
- **代码**:
```javascript
/**
 * 将字段标签转换为语种名称（用于v1 API）
 * @param {string} fieldLabel - 字段标签，如"英文翻译"
 * @returns {string} 语种名称，如"英文"
 */
mapFieldLabelToLanguageName(fieldLabel) {
  const mapping = {
    "中文翻译": "中文",
    "英文翻译": "英文",
    "俄文翻译": "俄文",
    "西文翻译": "西文",
    "法文翻译": "法文",
  };
  return mapping[fieldLabel] || fieldLabel;
},
```


**方法2: mapFieldLabelToFieldValue**（字段标签 -> 字段值）

- **位置**: 紧接在上一个方法之后
- **代码**:
```javascript
/**
 * 将字段标签转换为字段值（用于v2校验API）
 * @param {string} fieldLabel - 字段标签，如"英文翻译"
 * @returns {string} 字段值，如"english"
 */
mapFieldLabelToFieldValue(fieldLabel) {
  // 从entryParams.exportFields中查找对应的value
  const field = entryParams.exportFields.find(item => item.label === fieldLabel);
  return field ? field.value : fieldLabel;
},
```


#### 修改6: 修改校验模式的字段转换（第488-502行，handleOK方法内）

- **当前**: `this.formModel.backfillFields` 直接传递给 `entryValidate_v2`
- **修改为**: 将字段标签数组转换为字段值数组
- **位置**: 在 `entryValidate_v2` 调用前添加转换
- **代码**:
```javascript
// 将字段标签转换为字段值（v2校验API需要字段值）
const backfillFieldValues = this.formModel.backfillFields.map(
  label => this.mapFieldLabelToFieldValue(label)
);
result = await entryValidate_v2(
  this.formModel.originExcel,
  this.formModel.backFillFile,
  this.needRelationFile ? this.formModel.relationFile : null,
  this.formModel.checkFields,
  backfillFieldValues, // 使用转换后的字段值数组
  {
    emptyStringAsValue: this.formModel.emptyStringAsValue,
    failFast: this.formModel.failFast,
    checkSpecialChar: this.formModel.checkSpecialChar,
    checkMaxLength: this.formModel.checkMaxLength
  }
);
```


#### 修改7: 修改更新模式的API调用（第536-546行，handleOK方法内）

- **当前**: 调用 `entryBatchImportExcel_v2`
- **修改为**: 调用 `entryBatchImportExcel`，并传入语种名称数组和FormData
- **代码替换**:
```javascript
// v1.5使用v1的更新API：需要将字段标签转换为语种名称，并构建FormData
// 将字段标签转换为语种名称数组
const translateTypes = this.formModel.backfillFields.map(
  label => this.mapFieldLabelToLanguageName(label)
);

// 构建FormData（v1 API需要FormData格式）
const formData = new FormData();
formData.append("excel", this.formModel.backFillFile);
if (this.needRelationFile && this.formModel.relationFile) {
  formData.append("mappingJson", this.formModel.relationFile);
}

// 调用v1的批量导入API
result = await entryBatchImportExcel(
  translateTypes, // 语种名称数组，如["英文", "俄文"]
  formData
);
```


### 文件2: `tests/unit/components/BackFillModal_v1_5.test.js`

#### 修改1: 组件导入和名称（第7行）

- **当前**: `import BackFillModal_v2 from '@/components/Button/fileManage/backFill/modal_v2.vue'`
- **修改为**: `import BackFillModal_v1_5 from '@/components/Button/fileManage/backFill/modal_v1_5.vue'`

#### 修改2: Mock更新（第11-27行）

- **当前**: `entryBatchImportExcel_v2` 的mock
- **修改为**: `entryBatchImportExcel` 的mock
- **代码**:
```javascript
vi.mock('@/utils/excelUtils', () => ({
  entryBatchImportExcel: vi.fn(() => Promise.resolve({
    code: 200,
    success: ['英文', '俄文'],
    failed: new Map(),
    failedEntryInfos: [],
    exceptionVos: [],
    globalMessage: ''
  })),
  entryValidate_v2: vi.fn(() => Promise.resolve({
    code: 200,
    success: ['词条'],
    failed: new Map(),
    failedEntryInfos: [],
    exceptionVos: [],
    globalMessage: ''
  }))
}))
```


#### 修改3: describe块名称（第73行）

- **当前**: `describe('BackFillModal_v2 - 去重回填模态框 (v2版本)', () => {`
- **修改为**: `describe('BackFillModal_v1_5 - 去重回填模态框 (v1.5版本)', () => {`

#### 修改4: 所有组件引用（所有 `BackFillModal_v2` 替换为 `BackFillModal_v1_5`）

- 使用查找替换功能，将所有 `BackFillModal_v2` 替换为 `BackFillModal_v1_5`
- 影响位置：第85行、第110行、第136行等所有 `mount(BackFillModal_v2, ...)` 的地方

#### 修改5: Mock数据中的exportFields（第50-59行）

- **当前**: mock中只有部分字段
- **建议**: 添加完整的语种字段，便于测试过滤逻辑
- **代码**:
```javascript
vi.mock('@/constants/commonParam.js', () => ({
  entryParams: {
    exportFields: [
      { label: '词条', value: 'entry', index: 1 },
      { label: '中文翻译', value: 'chinese', index: 9 },
      { label: '英文翻译', value: 'english', index: 12 },
      { label: '俄文翻译', value: 'russian', index: 15 },
      { label: '西文翻译', value: 'spanish', index: 18 },
      { label: '法文翻译', value: 'french', index: 21 },
      { label: 'tag', value: 'tag', index: 3 },
      { label: 'comment', value: 'comment', index: 4 },
      { label: '英文翻译id', value: 'englishId', index: 4 }
    ]
  }
}))
```


#### 修改6: 更新模式API调用测试（第352-374行）

- **当前**: 验证调用 `entryBatchImportExcel_v2`
- **修改为**: 验证调用 `entryBatchImportExcel`，并验证传入参数为语种名称数组
- **代码**:
```javascript
it('updateTranslation模式下应该调用entryBatchImportExcel并传入语种名称', async () => {
  const { entryBatchImportExcel } = await import('@/utils/excelUtils')
  
  // ... 设置表单数据 ...
  wrapper.vm.formModel.backfillFields = ['英文翻译', '俄文翻译']
  
  await wrapper.vm.handleOK()
  // ... 等待异步完成 ...
  
  expect(entryBatchImportExcel).toHaveBeenCalled()
  const callArgs = entryBatchImportExcel.mock.calls[0]
  expect(callArgs[0]).toEqual(['英文', '俄文']) // 验证语种名称数组
  expect(callArgs[1]).toBeInstanceOf(FormData) // 验证FormData
})
```


#### 修改7: 添加字段映射方法测试（新增测试块）

- **位置**: 在字段过滤测试之后添加新的describe块
- **代码**:
```javascript
describe('字段映射方法', () => {
  // 测试mapFieldLabelToLanguageName
  it('应该正确映射字段标签到语种名称', () => {
    expect(wrapper.vm.mapFieldLabelToLanguageName('英文翻译')).toBe('英文')
    expect(wrapper.vm.mapFieldLabelToLanguageName('俄文翻译')).toBe('俄文')
  })
  
  // 测试mapFieldLabelToFieldValue
  it('应该正确映射字段标签到字段值', () => {
    expect(wrapper.vm.mapFieldLabelToFieldValue('英文翻译')).toBe('english')
    expect(wrapper.vm.mapFieldLabelToFieldValue('俄文翻译')).toBe('russian')
  })
})
```


#### 修改8: 字段过滤测试更新（第199-227行）

- **当前**: 测试过滤翻译id字段
- **修改为**: 测试只保留语种字段，过滤非语种字段
- **代码**:
```javascript
it('应该只显示语种字段，过滤掉非语种字段', async () => {
  // ... 挂载组件 ...
  
  await nextTick()
  await new Promise(resolve => setTimeout(resolve, 50))
  
  const fieldOptions = wrapper.vm.fieldOptions
  // 验证包含语种字段
  expect(fieldOptions.some(item => item.label === '英文翻译')).toBe(true)
  expect(fieldOptions.some(item => item.label === '俄文翻译')).toBe(true)
  // 验证不包含非语种字段
  expect(fieldOptions.some(item => item.label === '词条')).toBe(false)
  expect(fieldOptions.some(item => item.label === 'tag')).toBe(false)
  expect(fieldOptions.some(item => item.label === 'comment')).toBe(false)
})
```


## 数据映射参考

从 `src/constants/commonParam.js` 中获取的映射关系：

| 字段标签 | 字段值 | 语种名称 |

|---------|--------|---------|

| 中文翻译 | chinese | 中文 |

| 英文翻译 | english | 英文 |

| 俄文翻译 | russian | 俄文 |

| 西文翻译 | spanish | 西文 |

| 法文翻译 | french | 法文 |

## API调用差异

### v1 API (`entryBatchImportExcel`)

- **参数**: `(translateTypes: string[], formData: FormData)`
- **translateTypes**: 语种名称数组，如 `["英文", "俄文"]`
- **FormData**: 包含 `excel` 文件和可选的 `mappingJson`

### v2校验API (`entryValidate_v2`)

- **参数**: `(originExcel, dedupExcel, mappingJson, checkFields, backfillFields, options)`
- **backfillFields**: 字段值数组，如 `["english", "russian"]`